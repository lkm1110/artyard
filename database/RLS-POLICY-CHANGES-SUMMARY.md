# RLS 정책 변경 요약

## 🎯 목표
- 사용자 경험 개선 (로그인, 작품 조회 등)
- 불필요한 406/403 에러 제거
- 보안은 유지하되, 공개되어야 할 데이터는 공개

---

## 🔓 완전 공개 (RLS 비활성화)

### 왜 공개해야 하나요?
SNS/커뮤니티 플랫폼의 핵심 기능은 "공유"와 "소통"입니다.

| 테이블 | 변경 전 | 변경 후 | 이유 |
|--------|---------|---------|------|
| **artworks** | ❌ RLS 활성화 | ✅ RLS 비활성화 | 작품을 모두에게 보여야 플랫폼 의미 있음 |
| **likes** | ❌ RLS 활성화 | ✅ RLS 비활성화 | 좋아요 수는 공개 정보 |
| **bookmarks** | ❌ RLS 활성화 | ✅ RLS 비활성화 | 북마크 수도 공개 정보 |
| **follows** | ❌ RLS 활성화 | ✅ RLS 비활성화 | 팔로워 수는 공개 정보 |
| **comments** | ❌ RLS 활성화 | ✅ RLS 비활성화 | 댓글은 공개 소통 수단 |
| **reviews** | ❌ RLS 활성화 | ✅ RLS 비활성화 | 리뷰는 구매자 참고용 공개 정보 |
| **challenges** | ❌ RLS 활성화 | ✅ RLS 비활성화 | 챌린지는 모두가 참여 가능 |
| **challenge_entries** | ❌ RLS 활성화 | ✅ RLS 비활성화 | 챌린지 참가작은 공개 |

---

## 🔒 부분 보호 (간단한 RLS)

### profiles
```yaml
SELECT: 누구나 조회 가능 (공개 프로필)
INSERT: 본인만 생성 가능
UPDATE: 본인 또는 관리자만 수정 가능
DELETE: 본인만 삭제 가능
```

**변경 전 문제:**
- RLS 정책이 복잡해서 프로필 조회 실패
- 로그인 시 프로필을 못 불러와서 새로 생성 시도
- lavlna280 → artist89 문제 발생

**변경 후:**
- 누구나 프로필을 볼 수 있음 (다른 사용자 프로필 조회)
- 본인 정보만 수정/삭제 가능
- 관리자는 is_admin 수정 가능

---

### messages & chats
```yaml
SELECT: 본인이 참여한 채팅/메시지만
INSERT: 본인이 참여한 채팅방에만
UPDATE: 본인이 보낸 메시지만
DELETE: 본인이 보낸 메시지만
```

**이유:**
- 개인 메시지는 프라이버시 보호 필요
- 다른 사람의 메시지를 볼 수 없어야 함

---

### transactions
```yaml
SELECT: 구매자, 판매자, 관리자만
INSERT: 구매자만
UPDATE: 구매자 또는 판매자만
```

**이유:**
- 거래 정보는 민감 정보 (가격, 배송지 등)
- 당사자만 접근 가능해야 함
- 관리자는 분쟁 해결 위해 조회 가능

---

## 🚨 발생했던 문제들

### 1. 로그인 시 프로필 조회 실패
```
원인: profiles 테이블 RLS가 SELECT를 차단
결과: 프로필 못 불러옴 → 새 프로필 생성 시도 → lavlna280
해결: SELECT를 모두에게 공개
```

### 2. 홈 화면에 작품 안 보임
```
원인: artworks 테이블 RLS가 작품 조회 차단
결과: 빈 피드
해결: artworks RLS 완전 비활성화
```

### 3. 406 에러 (likes, bookmarks, follows)
```
원인: 복잡한 RLS 정책 충돌
결과: 기능은 작동하지만 406 에러 발생
해결: RLS 완전 비활성화
```

---

## ✅ 보안은 괜찮나요?

### 여전히 보호되는 것들:
- ✅ 개인 메시지 (messages, chats)
- ✅ 거래 정보 (transactions)
- ✅ 프로필 수정 (본인만)
- ✅ 계정 삭제 (본인만)

### 공개되는 것들 (원래 공개되어야 함):
- ✅ 작품 목록
- ✅ 좋아요/북마크/팔로우 수
- ✅ 댓글, 리뷰
- ✅ 챌린지

**결론:** Instagram, Twitter 같은 SNS도 공개 정보는 모두 공개합니다!

---

## 🚀 실행 방법

1. **Supabase SQL Editor에서 실행:**
```sql
-- 이 파일을 실행하세요
database/SIMPLIFY-ALL-RLS.sql
```

2. **앱 재시작:**
```bash
npm start
```

3. **재로그인:**
- Sign Out → 다시 로그인
- 이제 @artist89로 표시될 것
- 작품 3개가 모두 보일 것

---

## 📊 Before & After

### Before:
```yaml
문제:
  ❌ 로그인 시 프로필 못 불러옴
  ❌ 작품이 홈에서 안 보임
  ❌ 406 에러 지속
  ❌ lavlna280 표시 (잘못된 handle)
```

### After:
```yaml
해결:
  ✅ 로그인 시 프로필 정상 로드
  ✅ 작품 3개 모두 표시
  ✅ 406 에러 제거
  ✅ artist89 표시 (정상)
```

---

## 🎓 참고: 다른 SNS 플랫폼의 RLS

### Instagram
- 게시물: 공개 (팔로워만 or 전체 공개)
- 좋아요/댓글: 공개
- DM: 비공개

### Twitter
- 트윗: 공개
- 좋아요/리트윗: 공개
- DM: 비공개

### ArtYard (우리 플랫폼)
- 작품: 공개 ✅
- 좋아요/북마크/팔로우: 공개 ✅
- 메시지: 비공개 ✅
- 거래: 당사자만 ✅

**결론:** 우리 정책이 정상입니다! 🎉

