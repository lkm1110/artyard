# 💳 아임포트 완벽 연동 가이드

## 🎯 **왜 아임포트인가?**

```
✅ 한국 최고의 통합 결제 솔루션
✅ 여러 PG사 한 번에 (토스, 나이스, KG 등)
✅ 카카오페이, 네이버페이, 페이코 지원
✅ React Native 완벽 지원
✅ 한글 문서
✅ 수수료 저렴 (3.3~3.8%)
✅ 실제 서비스 가능!
```

---

## 🚀 **5분 시작 가이드**

### **1. 회원가입**
```
https://www.iamport.kr
→ 회원가입 (무료)
→ 이메일 인증
```

### **2. 가맹점 식별코드 발급**
```
대시보드 → 시스템 설정 → 내 식별코드
→ imp12345678 (이런 형식)
→ 복사!
```

### **3. PG사 선택 (토스페이먼츠 추천)**
```
대시보드 → 시스템 설정 → PG 설정(일반결제)
→ 토스페이먼츠 선택
→ 테스트 모드로 시작 (사업자 등록 전에도 가능!)
```

---

## 📦 **패키지 설치**

```bash
npm install react-native-iamport-payment
```

---

## 🔧 **환경변수 설정**

### **.env 파일**
```env
# 아임포트
EXPO_PUBLIC_IAMPORT_CODE=imp12345678

# Supabase (기존)
EXPO_PUBLIC_SUPABASE_URL=https://...
EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJ...
```

---

## 💻 **CheckoutScreen 수정**

### **완전한 코드**

```typescript
import React, { useState } from 'react';
import { View, Text, TouchableOpacity, Alert } from 'react-native';
import IMP from 'react-native-iamport-payment';
import { useNavigation, useRoute } from '@react-navigation/native';
import { createPaymentIntent, confirmPayment } from '../services/transactionService';

const IAMPORT_CODE = process.env.EXPO_PUBLIC_IAMPORT_CODE || '';

export const CheckoutScreen = () => {
  const navigation = useNavigation();
  const route = useRoute();
  const { artworkId } = route.params;
  
  const [loading, setLoading] = useState(false);
  const [artwork, setArtwork] = useState(null);
  const [selectedAddress, setSelectedAddress] = useState(null);

  // 기존 로직 (작품 로드, 주소 선택 등)
  // ...

  const handlePayment = async () => {
    try {
      setLoading(true);
      
      // 1. Transaction 생성 (기존 로직)
      const paymentResponse = await createPaymentIntent({
        artwork_id: artworkId,
        shipping_address_id: selectedAddress.id,
      });
      
      // 2. 아임포트 결제 요청
      const data = {
        pg: 'tosspay',                    // 토스페이먼츠
        pay_method: 'card',               // 카드 결제
        merchant_uid: paymentResponse.transaction_id, // 거래 ID
        name: artwork.title,              // 주문명
        amount: paymentResponse.total_amount, // 금액
        buyer_name: selectedAddress.recipient_name,
        buyer_tel: selectedAddress.phone,
        buyer_addr: selectedAddress.address,
        buyer_postcode: selectedAddress.postal_code,
        app_scheme: 'artyard',            // 앱 스킴
      };
      
      // 3. 아임포트 결제 실행
      IMP.payment(IAMPORT_CODE, data, (response) => {
        if (response.success) {
          // 결제 성공!
          handlePaymentSuccess(response);
        } else {
          // 결제 실패
          Alert.alert('결제 실패', response.error_msg);
          setLoading(false);
        }
      });
      
    } catch (error) {
      Alert.alert('오류', error.message);
      setLoading(false);
    }
  };
  
  const handlePaymentSuccess = async (response) => {
    try {
      // 4. 백엔드에 결제 확인 요청
      const success = await confirmPayment(
        response.merchant_uid,  // transaction_id
        response.imp_uid        // 아임포트 고유 ID
      );
      
      if (success) {
        Alert.alert(
          '결제 완료! 🎉',
          '주문이 접수되었습니다.',
          [{
            text: '확인',
            onPress: () => navigation.navigate('OrderDetail', {
              id: response.merchant_uid,
            }),
          }]
        );
      }
    } catch (error) {
      Alert.alert('오류', '결제는 완료되었으나 확인 중 오류가 발생했습니다.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <View>
      {/* 기존 UI (작품 정보, 배송지 등) */}
      
      <TouchableOpacity 
        onPress={handlePayment}
        disabled={loading}
      >
        <Text>결제하기</Text>
      </TouchableOpacity>
    </View>
  );
};
```

---

## 🔧 **transactionService.ts 수정**

### **confirmPayment 함수 업데이트**

```typescript
export const confirmPayment = async (
  transactionId: string,
  impUid: string  // 아임포트 고유 ID
): Promise<boolean> => {
  try {
    console.log('✅ 결제 완료 처리:', transactionId);
    
    // Transaction 상태 업데이트
    const { error } = await supabase
      .from('transactions')
      .update({
        status: 'paid',
        stripe_payment_intent_id: impUid,  // 아임포트 ID 저장
        paid_at: new Date().toISOString(),
        auto_confirm_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
      })
      .eq('id', transactionId);
    
    if (error) {
      console.error('결제 확인 실패:', error);
      return false;
    }
    
    // 판매자에게 알림
    const { data: transaction } = await supabase
      .from('transactions')
      .select('*, artwork:artworks(*), seller:profiles!transactions_seller_id_fkey(*)')
      .eq('id', transactionId)
      .single();
    
    if (transaction) {
      await supabase.from('notifications').insert({
        user_id: transaction.seller_id,
        type: 'new_sale',
        title: '새로운 주문이 있습니다! 🎉',
        message: `${transaction.artwork.title} 작품이 판매되었습니다.`,
        link: `/sales/${transactionId}`,
      });
    }
    
    return true;
    
  } catch (error: any) {
    console.error('❌ 결제 완료 처리 오류:', error);
    return false;
  }
};
```

---

## 🎨 **지원되는 결제 수단**

### **카드**
```typescript
pay_method: 'card'
```

### **카카오페이**
```typescript
pay_method: 'kakaopay'
```

### **네이버페이**
```typescript
pay_method: 'naverpay'
```

### **토스페이**
```typescript
pay_method: 'tosspay'
```

### **계좌이체**
```typescript
pay_method: 'trans'
```

### **가상계좌**
```typescript
pay_method: 'vbank'
```

---

## 💰 **수수료 비교**

| PG사 | 수수료 | 정산 | 특징 |
|------|--------|------|------|
| **토스페이먼츠** | 3.3% | D+1 | 빠른 정산 ✅ |
| **나이스페이** | 3.5% | D+2 | 안정적 |
| **KG이니시스** | 3.8% | D+3 | 가상계좌 강함 |
| **카카오페이** | 3.5% | D+2 | 간편결제 |

---

## 🧪 **테스트 카드**

### **토스페이먼츠 테스트**
```
카드번호: 아무거나 16자리
유효기간: 미래 날짜
CVC: 아무거나 3자리
비밀번호: 아무거나 2자리
```

### **실제 결제 흐름 테스트**
```
1. 테스트 모드로 결제
2. 모든 과정 확인
3. 실제 돈 안 빠져나감!
4. 완벽하게 테스트 가능
```

---

## 🔒 **보안 & Webhook**

### **Webhook 설정**
```
1. 아임포트 대시보드
2. 시스템 설정 → Webhook
3. URL 입력: https://your-api.com/webhook/iamport
4. 결제 완료 시 자동 알림
```

### **Webhook 처리 (Supabase Edge Function)**
```typescript
// supabase/functions/iamport-webhook/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from '@supabase/supabase-js'

serve(async (req) => {
  const { imp_uid, merchant_uid, status } = await req.json();
  
  if (status === 'paid') {
    // Transaction 상태 업데이트
    const supabase = createClient(...)
    await supabase
      .from('transactions')
      .update({ status: 'paid' })
      .eq('id', merchant_uid);
  }
  
  return new Response('ok', { status: 200 });
});
```

---

## 📊 **대시보드**

### **거래 내역 확인**
```
아임포트 대시보드 → 결제내역
→ 실시간으로 모든 거래 확인
→ 정산 예정 금액
→ 취소/환불 처리
```

---

## 🎯 **장점 요약**

```
✅ 한국 서비스에 최적화
✅ 여러 결제 수단 한 번에
✅ 코드 간단 (10줄이면 됨!)
✅ 문서 한글로 되어 있음
✅ 수수료 저렴 (3.3%)
✅ 정산 빠름 (D+1)
✅ 테스트 쉬움
✅ 실제 서비스 가능!
```

---

## 🚀 **시작하기**

```bash
# 1. 패키지 설치
npm install react-native-iamport-payment

# 2. 아임포트 가입
https://www.iamport.kr

# 3. 코드 수정 (위 예시 참고)

# 4. 테스트!
```

---

## 📚 **참고 자료**

- [아임포트 공식 문서](https://docs.iamport.kr/)
- [React Native 가이드](https://docs.iamport.kr/sdk/react-native)
- [결제 연동 예제](https://github.com/iamport/iamport-react-native)

---

**아임포트가 최고입니다!** 🚀🇰🇷

