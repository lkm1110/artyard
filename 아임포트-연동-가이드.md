# ğŸ’³ ì•„ì„í¬íŠ¸ ì™„ë²½ ì—°ë™ ê°€ì´ë“œ

## ğŸ¯ **ì™œ ì•„ì„í¬íŠ¸ì¸ê°€?**

```
âœ… í•œêµ­ ìµœê³ ì˜ í†µí•© ê²°ì œ ì†”ë£¨ì…˜
âœ… ì—¬ëŸ¬ PGì‚¬ í•œ ë²ˆì— (í† ìŠ¤, ë‚˜ì´ìŠ¤, KG ë“±)
âœ… ì¹´ì¹´ì˜¤í˜ì´, ë„¤ì´ë²„í˜ì´, í˜ì´ì½” ì§€ì›
âœ… React Native ì™„ë²½ ì§€ì›
âœ… í•œê¸€ ë¬¸ì„œ
âœ… ìˆ˜ìˆ˜ë£Œ ì €ë ´ (3.3~3.8%)
âœ… ì‹¤ì œ ì„œë¹„ìŠ¤ ê°€ëŠ¥!
```

---

## ğŸš€ **5ë¶„ ì‹œì‘ ê°€ì´ë“œ**

### **1. íšŒì›ê°€ì…**
```
https://www.iamport.kr
â†’ íšŒì›ê°€ì… (ë¬´ë£Œ)
â†’ ì´ë©”ì¼ ì¸ì¦
```

### **2. ê°€ë§¹ì  ì‹ë³„ì½”ë“œ ë°œê¸‰**
```
ëŒ€ì‹œë³´ë“œ â†’ ì‹œìŠ¤í…œ ì„¤ì • â†’ ë‚´ ì‹ë³„ì½”ë“œ
â†’ imp12345678 (ì´ëŸ° í˜•ì‹)
â†’ ë³µì‚¬!
```

### **3. PGì‚¬ ì„ íƒ (í† ìŠ¤í˜ì´ë¨¼ì¸  ì¶”ì²œ)**
```
ëŒ€ì‹œë³´ë“œ â†’ ì‹œìŠ¤í…œ ì„¤ì • â†’ PG ì„¤ì •(ì¼ë°˜ê²°ì œ)
â†’ í† ìŠ¤í˜ì´ë¨¼ì¸  ì„ íƒ
â†’ í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹œì‘ (ì‚¬ì—…ì ë“±ë¡ ì „ì—ë„ ê°€ëŠ¥!)
```

---

## ğŸ“¦ **íŒ¨í‚¤ì§€ ì„¤ì¹˜**

```bash
npm install react-native-iamport-payment
```

---

## ğŸ”§ **í™˜ê²½ë³€ìˆ˜ ì„¤ì •**

### **.env íŒŒì¼**
```env
# ì•„ì„í¬íŠ¸
EXPO_PUBLIC_IAMPORT_CODE=imp12345678

# Supabase (ê¸°ì¡´)
EXPO_PUBLIC_SUPABASE_URL=https://...
EXPO_PUBLIC_SUPABASE_ANON_KEY=eyJ...
```

---

## ğŸ’» **CheckoutScreen ìˆ˜ì •**

### **ì™„ì „í•œ ì½”ë“œ**

```typescript
import React, { useState } from 'react';
import { View, Text, TouchableOpacity, Alert } from 'react-native';
import IMP from 'react-native-iamport-payment';
import { useNavigation, useRoute } from '@react-navigation/native';
import { createPaymentIntent, confirmPayment } from '../services/transactionService';

const IAMPORT_CODE = process.env.EXPO_PUBLIC_IAMPORT_CODE || '';

export const CheckoutScreen = () => {
  const navigation = useNavigation();
  const route = useRoute();
  const { artworkId } = route.params;
  
  const [loading, setLoading] = useState(false);
  const [artwork, setArtwork] = useState(null);
  const [selectedAddress, setSelectedAddress] = useState(null);

  // ê¸°ì¡´ ë¡œì§ (ì‘í’ˆ ë¡œë“œ, ì£¼ì†Œ ì„ íƒ ë“±)
  // ...

  const handlePayment = async () => {
    try {
      setLoading(true);
      
      // 1. Transaction ìƒì„± (ê¸°ì¡´ ë¡œì§)
      const paymentResponse = await createPaymentIntent({
        artwork_id: artworkId,
        shipping_address_id: selectedAddress.id,
      });
      
      // 2. ì•„ì„í¬íŠ¸ ê²°ì œ ìš”ì²­
      const data = {
        pg: 'tosspay',                    // í† ìŠ¤í˜ì´ë¨¼ì¸ 
        pay_method: 'card',               // ì¹´ë“œ ê²°ì œ
        merchant_uid: paymentResponse.transaction_id, // ê±°ë˜ ID
        name: artwork.title,              // ì£¼ë¬¸ëª…
        amount: paymentResponse.total_amount, // ê¸ˆì•¡
        buyer_name: selectedAddress.recipient_name,
        buyer_tel: selectedAddress.phone,
        buyer_addr: selectedAddress.address,
        buyer_postcode: selectedAddress.postal_code,
        app_scheme: 'artyard',            // ì•± ìŠ¤í‚´
      };
      
      // 3. ì•„ì„í¬íŠ¸ ê²°ì œ ì‹¤í–‰
      IMP.payment(IAMPORT_CODE, data, (response) => {
        if (response.success) {
          // ê²°ì œ ì„±ê³µ!
          handlePaymentSuccess(response);
        } else {
          // ê²°ì œ ì‹¤íŒ¨
          Alert.alert('ê²°ì œ ì‹¤íŒ¨', response.error_msg);
          setLoading(false);
        }
      });
      
    } catch (error) {
      Alert.alert('ì˜¤ë¥˜', error.message);
      setLoading(false);
    }
  };
  
  const handlePaymentSuccess = async (response) => {
    try {
      // 4. ë°±ì—”ë“œì— ê²°ì œ í™•ì¸ ìš”ì²­
      const success = await confirmPayment(
        response.merchant_uid,  // transaction_id
        response.imp_uid        // ì•„ì„í¬íŠ¸ ê³ ìœ  ID
      );
      
      if (success) {
        Alert.alert(
          'ê²°ì œ ì™„ë£Œ! ğŸ‰',
          'ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.',
          [{
            text: 'í™•ì¸',
            onPress: () => navigation.navigate('OrderDetail', {
              id: response.merchant_uid,
            }),
          }]
        );
      }
    } catch (error) {
      Alert.alert('ì˜¤ë¥˜', 'ê²°ì œëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <View>
      {/* ê¸°ì¡´ UI (ì‘í’ˆ ì •ë³´, ë°°ì†¡ì§€ ë“±) */}
      
      <TouchableOpacity 
        onPress={handlePayment}
        disabled={loading}
      >
        <Text>ê²°ì œí•˜ê¸°</Text>
      </TouchableOpacity>
    </View>
  );
};
```

---

## ğŸ”§ **transactionService.ts ìˆ˜ì •**

### **confirmPayment í•¨ìˆ˜ ì—…ë°ì´íŠ¸**

```typescript
export const confirmPayment = async (
  transactionId: string,
  impUid: string  // ì•„ì„í¬íŠ¸ ê³ ìœ  ID
): Promise<boolean> => {
  try {
    console.log('âœ… ê²°ì œ ì™„ë£Œ ì²˜ë¦¬:', transactionId);
    
    // Transaction ìƒíƒœ ì—…ë°ì´íŠ¸
    const { error } = await supabase
      .from('transactions')
      .update({
        status: 'paid',
        stripe_payment_intent_id: impUid,  // ì•„ì„í¬íŠ¸ ID ì €ì¥
        paid_at: new Date().toISOString(),
        auto_confirm_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
      })
      .eq('id', transactionId);
    
    if (error) {
      console.error('ê²°ì œ í™•ì¸ ì‹¤íŒ¨:', error);
      return false;
    }
    
    // íŒë§¤ìì—ê²Œ ì•Œë¦¼
    const { data: transaction } = await supabase
      .from('transactions')
      .select('*, artwork:artworks(*), seller:profiles!transactions_seller_id_fkey(*)')
      .eq('id', transactionId)
      .single();
    
    if (transaction) {
      await supabase.from('notifications').insert({
        user_id: transaction.seller_id,
        type: 'new_sale',
        title: 'ìƒˆë¡œìš´ ì£¼ë¬¸ì´ ìˆìŠµë‹ˆë‹¤! ğŸ‰',
        message: `${transaction.artwork.title} ì‘í’ˆì´ íŒë§¤ë˜ì—ˆìŠµë‹ˆë‹¤.`,
        link: `/sales/${transactionId}`,
      });
    }
    
    return true;
    
  } catch (error: any) {
    console.error('âŒ ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
    return false;
  }
};
```

---

## ğŸ¨ **ì§€ì›ë˜ëŠ” ê²°ì œ ìˆ˜ë‹¨**

### **ì¹´ë“œ**
```typescript
pay_method: 'card'
```

### **ì¹´ì¹´ì˜¤í˜ì´**
```typescript
pay_method: 'kakaopay'
```

### **ë„¤ì´ë²„í˜ì´**
```typescript
pay_method: 'naverpay'
```

### **í† ìŠ¤í˜ì´**
```typescript
pay_method: 'tosspay'
```

### **ê³„ì¢Œì´ì²´**
```typescript
pay_method: 'trans'
```

### **ê°€ìƒê³„ì¢Œ**
```typescript
pay_method: 'vbank'
```

---

## ğŸ’° **ìˆ˜ìˆ˜ë£Œ ë¹„êµ**

| PGì‚¬ | ìˆ˜ìˆ˜ë£Œ | ì •ì‚° | íŠ¹ì§• |
|------|--------|------|------|
| **í† ìŠ¤í˜ì´ë¨¼ì¸ ** | 3.3% | D+1 | ë¹ ë¥¸ ì •ì‚° âœ… |
| **ë‚˜ì´ìŠ¤í˜ì´** | 3.5% | D+2 | ì•ˆì •ì  |
| **KGì´ë‹ˆì‹œìŠ¤** | 3.8% | D+3 | ê°€ìƒê³„ì¢Œ ê°•í•¨ |
| **ì¹´ì¹´ì˜¤í˜ì´** | 3.5% | D+2 | ê°„í¸ê²°ì œ |

---

## ğŸ§ª **í…ŒìŠ¤íŠ¸ ì¹´ë“œ**

### **í† ìŠ¤í˜ì´ë¨¼ì¸  í…ŒìŠ¤íŠ¸**
```
ì¹´ë“œë²ˆí˜¸: ì•„ë¬´ê±°ë‚˜ 16ìë¦¬
ìœ íš¨ê¸°ê°„: ë¯¸ë˜ ë‚ ì§œ
CVC: ì•„ë¬´ê±°ë‚˜ 3ìë¦¬
ë¹„ë°€ë²ˆí˜¸: ì•„ë¬´ê±°ë‚˜ 2ìë¦¬
```

### **ì‹¤ì œ ê²°ì œ íë¦„ í…ŒìŠ¤íŠ¸**
```
1. í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ê²°ì œ
2. ëª¨ë“  ê³¼ì • í™•ì¸
3. ì‹¤ì œ ëˆ ì•ˆ ë¹ ì ¸ë‚˜ê°!
4. ì™„ë²½í•˜ê²Œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
```

---

## ğŸ”’ **ë³´ì•ˆ & Webhook**

### **Webhook ì„¤ì •**
```
1. ì•„ì„í¬íŠ¸ ëŒ€ì‹œë³´ë“œ
2. ì‹œìŠ¤í…œ ì„¤ì • â†’ Webhook
3. URL ì…ë ¥: https://your-api.com/webhook/iamport
4. ê²°ì œ ì™„ë£Œ ì‹œ ìë™ ì•Œë¦¼
```

### **Webhook ì²˜ë¦¬ (Supabase Edge Function)**
```typescript
// supabase/functions/iamport-webhook/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from '@supabase/supabase-js'

serve(async (req) => {
  const { imp_uid, merchant_uid, status } = await req.json();
  
  if (status === 'paid') {
    // Transaction ìƒíƒœ ì—…ë°ì´íŠ¸
    const supabase = createClient(...)
    await supabase
      .from('transactions')
      .update({ status: 'paid' })
      .eq('id', merchant_uid);
  }
  
  return new Response('ok', { status: 200 });
});
```

---

## ğŸ“Š **ëŒ€ì‹œë³´ë“œ**

### **ê±°ë˜ ë‚´ì—­ í™•ì¸**
```
ì•„ì„í¬íŠ¸ ëŒ€ì‹œë³´ë“œ â†’ ê²°ì œë‚´ì—­
â†’ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë“  ê±°ë˜ í™•ì¸
â†’ ì •ì‚° ì˜ˆì • ê¸ˆì•¡
â†’ ì·¨ì†Œ/í™˜ë¶ˆ ì²˜ë¦¬
```

---

## ğŸ¯ **ì¥ì  ìš”ì•½**

```
âœ… í•œêµ­ ì„œë¹„ìŠ¤ì— ìµœì í™”
âœ… ì—¬ëŸ¬ ê²°ì œ ìˆ˜ë‹¨ í•œ ë²ˆì—
âœ… ì½”ë“œ ê°„ë‹¨ (10ì¤„ì´ë©´ ë¨!)
âœ… ë¬¸ì„œ í•œê¸€ë¡œ ë˜ì–´ ìˆìŒ
âœ… ìˆ˜ìˆ˜ë£Œ ì €ë ´ (3.3%)
âœ… ì •ì‚° ë¹ ë¦„ (D+1)
âœ… í…ŒìŠ¤íŠ¸ ì‰¬ì›€
âœ… ì‹¤ì œ ì„œë¹„ìŠ¤ ê°€ëŠ¥!
```

---

## ğŸš€ **ì‹œì‘í•˜ê¸°**

```bash
# 1. íŒ¨í‚¤ì§€ ì„¤ì¹˜
npm install react-native-iamport-payment

# 2. ì•„ì„í¬íŠ¸ ê°€ì…
https://www.iamport.kr

# 3. ì½”ë“œ ìˆ˜ì • (ìœ„ ì˜ˆì‹œ ì°¸ê³ )

# 4. í…ŒìŠ¤íŠ¸!
```

---

## ğŸ“š **ì°¸ê³  ìë£Œ**

- [ì•„ì„í¬íŠ¸ ê³µì‹ ë¬¸ì„œ](https://docs.iamport.kr/)
- [React Native ê°€ì´ë“œ](https://docs.iamport.kr/sdk/react-native)
- [ê²°ì œ ì—°ë™ ì˜ˆì œ](https://github.com/iamport/iamport-react-native)

---

**ì•„ì„í¬íŠ¸ê°€ ìµœê³ ì…ë‹ˆë‹¤!** ğŸš€ğŸ‡°ğŸ‡·

