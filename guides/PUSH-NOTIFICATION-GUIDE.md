# üîî Push Notification Íµ¨ÌòÑ Í∞ÄÏù¥Îìú

ArtYard Ïï±Ïóê Ìë∏Ïãú ÏïåÎ¶ºÏùÑ Ï∂îÍ∞ÄÌïòÎäî ÏôÑÎ≤Ω Í∞ÄÏù¥ÎìúÏûÖÎãàÎã§.

---

## üìã **ÌïÑÏöîÌïú ÏïåÎ¶º Ï¢ÖÎ•ò**

```yaml
1. ÏÜåÏÖú ÏïåÎ¶º:
   - ‚ù§Ô∏è Ï¢ãÏïÑÏöî (ÏÉà Ï¢ãÏïÑÏöî Î∞õÏïòÏùÑ Îïå)
   - üí¨ ÎåìÍ∏Ä (ÎÇ¥ ÏûëÌíàÏóê ÎåìÍ∏Ä)
   - üîñ Î∂ÅÎßàÌÅ¨
   - üë• ÌåîÎ°úÏö∞

2. Í±∞Îûò ÏïåÎ¶º:
   - üí∞ Í≤∞Ï†ú ÏôÑÎ£å
   - üì¶ Ï£ºÎ¨∏ Ï†ëÏàò
   - üöö Î∞∞ÏÜ° ÏãúÏûë
   - ‚úÖ Î∞∞ÏÜ° ÏôÑÎ£å
   - ‚≠ê Î¶¨Î∑∞ ÏöîÏ≤≠

3. Ï±åÎ¶∞ÏßÄ ÏïåÎ¶º:
   - üèÜ Ï±åÎ¶∞ÏßÄ ÎãπÏ≤®
   - üì¢ ÏÉà Ï±åÎ¶∞ÏßÄ ÏãúÏûë
   - ‚è∞ Ï±åÎ¶∞ÏßÄ ÎßàÍ∞ê ÏûÑÎ∞ï

4. ÏãúÏä§ÌÖú ÏïåÎ¶º:
   - üì± Ïï± ÏóÖÎç∞Ïù¥Ìä∏
   - üîß Ï†êÍ≤Ä Í≥µÏßÄ
   - ‚ö†Ô∏è Î≥¥Ïïà ÏïåÎ¶º
```

---

## üöÄ **Íµ¨ÌòÑ Î∞©Î≤ï (Expo ÏÇ¨Ïö©)**

### **Step 1: Expo Notifications ÏÑ§Ï†ï**

#### **1-1. Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò**
```bash
# Ïù¥ÎØ∏ ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏùå
expo install expo-notifications
```

#### **1-2. app.json ÏÑ§Ï†ï**
```json
{
  "expo": {
    "plugins": [
      [
        "expo-notifications",
        {
          "icon": "./assets/notification-icon.png",
          "color": "#E91E63",
          "sounds": ["./assets/notification.wav"]
        }
      ]
    ],
    "notification": {
      "icon": "./assets/notification-icon.png",
      "color": "#E91E63",
      "androidMode": "default",
      "androidCollapsedTitle": "New notification from ArtYard"
    }
  }
}
```

---

### **Step 2: Push Token ÏÉùÏÑ± Î∞è Ï†ÄÏû•**

#### **2-1. Ìë∏Ïãú ÌÜ†ÌÅ∞ ÏÑúÎπÑÏä§ ÏÉùÏÑ±**

**`src/services/pushNotificationService.ts`**
```typescript
import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import { Platform } from 'react-native';
import { supabase } from './supabase';

// ÏïåÎ¶º Ìï∏Îì§Îü¨ ÏÑ§Ï†ï
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
  }),
});

/**
 * Push Token Îì±Î°ù
 */
export const registerForPushNotifications = async (userId: string): Promise<string | null> => {
  try {
    // 1. Ïã§Ï†ú ÎîîÎ∞îÏù¥Ïä§ Ï≤¥ÌÅ¨
    if (!Device.isDevice) {
      console.warn('‚ö†Ô∏è Push notifications only work on physical devices');
      return null;
    }

    // 2. Í∂åÌïú ÏöîÏ≤≠
    const { status: existingStatus } = await Notifications.getPermissionsAsync();
    let finalStatus = existingStatus;
    
    if (existingStatus !== 'granted') {
      const { status } = await Notifications.requestPermissionsAsync();
      finalStatus = status;
    }
    
    if (finalStatus !== 'granted') {
      console.warn('‚ö†Ô∏è Push notification permission not granted');
      return null;
    }

    // 3. Push Token Î∞úÍ∏â
    const tokenData = await Notifications.getExpoPushTokenAsync({
      projectId: 'YOUR_EXPO_PROJECT_ID', // EAS ÌîÑÎ°úÏ†ùÌä∏ ID
    });
    
    const pushToken = tokenData.data;
    console.log('‚úÖ Push Token:', pushToken);

    // 4. SupabaseÏóê Ï†ÄÏû•
    const { error } = await supabase
      .from('push_tokens')
      .upsert({
        user_id: userId,
        push_token: pushToken,
        platform: Platform.OS,
        device_name: Device.deviceName || 'Unknown',
        updated_at: new Date().toISOString(),
      }, {
        onConflict: 'user_id,push_token'
      });

    if (error) {
      console.error('‚ùå Failed to save push token:', error);
      return null;
    }

    // 5. Android Ï±ÑÎÑê ÏÑ§Ï†ï
    if (Platform.OS === 'android') {
      await Notifications.setNotificationChannelAsync('default', {
        name: 'default',
        importance: Notifications.AndroidImportance.MAX,
        vibrationPattern: [0, 250, 250, 250],
        lightColor: '#E91E63',
      });
    }

    return pushToken;
  } catch (error) {
    console.error('‚ùå Push notification setup failed:', error);
    return null;
  }
};

/**
 * Push Token Ï†úÍ±∞ (Î°úÍ∑∏ÏïÑÏõÉ Ïãú)
 */
export const unregisterPushToken = async (userId: string) => {
  try {
    const { error } = await supabase
      .from('push_tokens')
      .delete()
      .eq('user_id', userId);

    if (error) throw error;
    console.log('‚úÖ Push token removed');
  } catch (error) {
    console.error('‚ùå Failed to remove push token:', error);
  }
};

/**
 * ÏïåÎ¶º ÏàòÏã† Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
 */
export const setupNotificationListeners = (
  onNotification: (notification: Notifications.Notification) => void,
  onNotificationResponse: (response: Notifications.NotificationResponse) => void
) => {
  // Ïï±Ïù¥ foregroundÏùº Îïå ÏïåÎ¶º ÏàòÏã†
  const notificationListener = Notifications.addNotificationReceivedListener(onNotification);

  // ÏïåÎ¶º ÌÅ¥Î¶≠ Ïãú
  const responseListener = Notifications.addNotificationResponseReceivedListener(onNotificationResponse);

  return () => {
    Notifications.removeNotificationSubscription(notificationListener);
    Notifications.removeNotificationSubscription(responseListener);
  };
};

/**
 * Î°úÏª¨ ÏïåÎ¶º (ÌÖåÏä§Ìä∏Ïö©)
 */
export const scheduleLocalNotification = async (title: string, body: string, data?: any) => {
  await Notifications.scheduleNotificationAsync({
    content: {
      title,
      body,
      data,
      sound: true,
    },
    trigger: { seconds: 1 },
  });
};
```

---

### **Step 3: Supabase ÌÖåÏù¥Î∏î ÏÉùÏÑ±**

**`database/push-notifications-schema.sql`**
```sql
-- Push Tokens ÌÖåÏù¥Î∏î
CREATE TABLE IF NOT EXISTS push_tokens (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  push_token TEXT NOT NULL,
  platform TEXT NOT NULL CHECK (platform IN ('ios', 'android', 'web')),
  device_name TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(user_id, push_token)
);

-- Ïù∏Îç±Ïä§
CREATE INDEX idx_push_tokens_user_id ON push_tokens(user_id);
CREATE INDEX idx_push_tokens_push_token ON push_tokens(push_token);

-- RLS Ï†ïÏ±Ö
ALTER TABLE push_tokens ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage own push tokens"
  ON push_tokens
  FOR ALL
  USING (auth.uid() = user_id);

-- Notification Queue ÌÖåÏù¥Î∏î (Î∞±Í∑∏ÎùºÏö¥Îìú Ï†ÑÏÜ°Ïö©)
CREATE TABLE IF NOT EXISTS notification_queue (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL,
  title TEXT NOT NULL,
  body TEXT NOT NULL,
  data JSONB,
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'sent', 'failed')),
  error_message TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  sent_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_notification_queue_status ON notification_queue(status);
CREATE INDEX idx_notification_queue_user_id ON notification_queue(user_id);
```

---

### **Step 4: App.tsxÏóê ÌÜµÌï©**

```typescript
// App.tsx
import { registerForPushNotifications, setupNotificationListeners } from './src/services/pushNotificationService';
import * as Notifications from 'expo-notifications';

export default function App() {
  const { user } = useAuthStore();

  useEffect(() => {
    if (user) {
      // Push Token Îì±Î°ù
      registerForPushNotifications(user.id);
    }
  }, [user]);

  useEffect(() => {
    // ÏïåÎ¶º Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
    const cleanup = setupNotificationListeners(
      // ÏïåÎ¶º ÏàòÏã†
      (notification) => {
        console.log('üîî Notification received:', notification);
      },
      // ÏïåÎ¶º ÌÅ¥Î¶≠
      (response) => {
        console.log('üëÜ Notification clicked:', response);
        const data = response.notification.request.content.data;
        
        // ÏïåÎ¶º ÌÉÄÏûÖÏóê Îî∞Îùº ÌôîÎ©¥ Ïù¥Îèô
        if (data.type === 'like') {
          navigation.navigate('ArtworkDetail', { artworkId: data.artworkId });
        } else if (data.type === 'comment') {
          navigation.navigate('ArtworkDetail', { artworkId: data.artworkId });
        } else if (data.type === 'order') {
          navigation.navigate('Orders');
        }
      }
    );

    return cleanup;
  }, []);

  // ... rest of app
}
```

---

### **Step 5: Supabase Edge FunctionÏúºÎ°ú ÏïåÎ¶º Ï†ÑÏÜ°**

**`supabase/functions/send-push-notification/index.ts`**
```typescript
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const EXPO_PUSH_URL = 'https://exp.host/--/api/v2/push/send';

serve(async (req) => {
  try {
    const { userId, title, body, data } = await req.json();

    // 1. Supabase ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÉùÏÑ±
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
    );

    // 2. ÏÇ¨Ïö©ÏûêÏùò Push Token Ï°∞Ìöå
    const { data: tokens, error: tokenError } = await supabase
      .from('push_tokens')
      .select('push_token')
      .eq('user_id', userId);

    if (tokenError || !tokens || tokens.length === 0) {
      return new Response(JSON.stringify({ error: 'No push tokens found' }), {
        status: 404,
      });
    }

    // 3. Expo Push Notification Ï†ÑÏÜ°
    const messages = tokens.map(({ push_token }) => ({
      to: push_token,
      sound: 'default',
      title,
      body,
      data,
      priority: 'high',
    }));

    const response = await fetch(EXPO_PUSH_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(messages),
    });

    const result = await response.json();
    console.log('Push notification sent:', result);

    return new Response(JSON.stringify({ success: true, result }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error) {
    console.error('Error:', error);
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
    });
  }
});
```

---

### **Step 6: Database TriggerÎ°ú ÏûêÎèô ÏïåÎ¶º**

```sql
-- Ï¢ãÏïÑÏöî ÏïåÎ¶º
CREATE OR REPLACE FUNCTION notify_artwork_like()
RETURNS TRIGGER AS $$
BEGIN
  -- Edge Function Ìò∏Ï∂ú
  PERFORM net.http_post(
    url := 'YOUR_SUPABASE_URL/functions/v1/send-push-notification',
    headers := jsonb_build_object(
      'Content-Type', 'application/json',
      'Authorization', 'Bearer YOUR_ANON_KEY'
    ),
    body := jsonb_build_object(
      'userId', (SELECT author_id FROM artworks WHERE id = NEW.artwork_id),
      'title', '‚ù§Ô∏è New Like!',
      'body', 'Someone liked your artwork!',
      'data', jsonb_build_object(
        'type', 'like',
        'artworkId', NEW.artwork_id
      )
    )
  );
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_notify_like
AFTER INSERT ON likes
FOR EACH ROW
EXECUTE FUNCTION notify_artwork_like();
```

---

## ‚úÖ **ÌÖåÏä§Ìä∏ Î∞©Î≤ï**

### **1. Î°úÏª¨ ÏïåÎ¶º ÌÖåÏä§Ìä∏**
```typescript
import { scheduleLocalNotification } from './src/services/pushNotificationService';

// Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú
await scheduleLocalNotification(
  'Test Notification',
  'This is a test!',
  { type: 'test' }
);
```

### **2. Expo GoÏóêÏÑú ÌÖåÏä§Ìä∏**
- Expo Go Ïï±ÏóêÏÑúÎäî ÏûêÎèôÏúºÎ°ú ÏûëÎèô
- Ïã§Ï†ú ÎîîÎ∞îÏù¥Ïä§ ÌïÑÏöî

### **3. ÌîÑÎ°úÎçïÏÖò ÎπåÎìú**
```bash
# iOS
eas build --platform ios --profile production

# Android
eas build --platform android --profile production
```

---

## üéØ **Ï∂îÍ∞Ä Í∏∞Îä•**

### **Î∞∞ÏßÄ Ïπ¥Ïö¥Ìä∏**
```typescript
import * as Notifications from 'expo-notifications';

// Î∞∞ÏßÄ ÏÑ§Ï†ï
await Notifications.setBadgeCountAsync(5);

// Î∞∞ÏßÄ ÌÅ¥Î¶¨Ïñ¥
await Notifications.setBadgeCountAsync(0);
```

### **ÏïåÎ¶º Í∑∏Î£πÌôî (Android)**
```typescript
await Notifications.scheduleNotificationAsync({
  content: {
    title: 'New Message',
    body: 'You have new messages',
    data: { type: 'message' },
  },
  trigger: null,
  identifier: 'messages-group', // Í∞ôÏùÄ Í∑∏Î£πÏúºÎ°ú
});
```

---

## üìù **Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏**

```yaml
‚ñ° expo-notifications ÏÑ§Ïπò
‚ñ° app.json ÏÑ§Ï†ï
‚ñ° pushNotificationService.ts ÏÉùÏÑ±
‚ñ° push_tokens ÌÖåÏù¥Î∏î ÏÉùÏÑ±
‚ñ° App.tsxÏóê ÌÜµÌï©
‚ñ° Edge Function Î∞∞Ìè¨
‚ñ° Database Trigger ÏÑ§Ï†ï
‚ñ° Ïã§Ï†ú ÎîîÎ∞îÏù¥Ïä§ÏóêÏÑú ÌÖåÏä§Ìä∏
‚ñ° iOS: Apple DeveloperÏóêÏÑú Push Notification Ïù∏Ï¶ùÏÑú ÏÑ§Ï†ï
‚ñ° Android: Firebase Cloud Messaging (FCM) ÏÑ§Ï†ï (ÏÑ†ÌÉù)
```

---

**ÏôÑÎ£å ÏòàÏÉÅ ÏãúÍ∞Ñ: 4-6ÏãúÍ∞Ñ** ‚è∞

